<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icybiscuit.idol.dao.mapper.RoomMsgRankMapper">
    <resultMap id="rank" type="com.icybiscuit.idol.entity.VO.RankVO">
        <result column="name" property="name"/>
        <result column="counts" property="counts"/>
        <result column="team" property="team"/>
        <result column="type" property="type"/>
    </resultMap>

    <select id="getRank" parameterType="java.lang.String" resultMap="rank">
        <choose>
            <when test="_parameter=='live'.toString() or _parameter=='diantai'.toString()">
                SELECT
                (SELECT
                info.member_name
                FROM
                t_memberinfo info
                WHERE
                info.room_id = msg.room_id) name,
                (SELECT
                info.member_team
                FROM
                t_memberinfo info
                WHERE
                info.room_id = msg.room_id) team,
                msg.type type,
                COUNT(msg.room_id) counts
                FROM
                (SELECT
                m.room_id,
                DATE(m.msg_time) msg_date,
                m.message_type type
                FROM
                t_roommsg m
                WHERE
                m.message_type = #{type}
                AND DATE_FORMAT(m.msg_time, '%Y%m') = DATE_FORMAT(CURRENT_DATE(), '%Y%m')
                GROUP BY m.room_id , msg_date
                HAVING COUNT(msg_date) >= 1) msg
                GROUP BY msg.room_id
                ORDER BY counts DESC
                limit 16
            </when>
            <otherwise>
                SELECT
                (SELECT
                info.member_name
                FROM
                t_memberinfo info
                WHERE
                info.room_id = m.room_id) name,
                (SELECT
                info.member_team
                FROM
                t_memberinfo info
                WHERE
                info.room_id = m.room_id) team,
                m.message_type type,
                COUNT(m.room_id) counts
                FROM
                t_roommsg m
                WHERE
                m.message_type = #{type}
                AND DATE_FORMAT(m.msg_time, '%Y%m') = DATE_FORMAT(CURRENT_DATE(), '%Y%m')
                GROUP BY m.room_id
                ORDER BY counts DESC
                LIMIT 16
            </otherwise>
        </choose>

    </select>

    <select id="getMsgTypes" resultType="java.lang.String">
        select msg_type
        from msg_type_view
    </select>

    <select id="getMsgCountByTeam" resultMap="rank">
    </select>

</mapper>

